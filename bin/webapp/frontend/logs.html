<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OctapusPrime – Security Logs</title>
  <style>
    /* ===== CSS Custom Properties ===== */
    :root {
      --primary-bg: #0d0d0d;
      --secondary-bg: #1a1a1a;
      --tertiary-bg: #262626;
      --primary-text: #e6e6e6;
      --secondary-text: #bbb;
      --accent-color: #39ff14;
      --accent-shadow: 0 0 8px #39ff14;
      --border-color: #333;
      --font-mono: "Roboto Mono", "Courier New", monospace;
      --transition: all 0.3s ease;
      --glow-intense: 0 0 25px #39ff14;
      --warning-color: #ff9500;
      --error-color: #ff4444;
      --info-color: #44aaff;
      --success-color: #00ff88;
    }

    /* ===== Reset & Base Styles ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--primary-bg);
      color: var(--primary-text);
      font-family: var(--font-mono);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ===== Animated Background ===== */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px);
      background-size: 30px 30px;
      animation: gridFlow 15s linear infinite;
      z-index: -1;
      pointer-events: none;
    }

    @keyframes gridFlow {
      0% { transform: translate(0, 0); }
      100% { transform: translate(30px, 30px); }
    }

    /* ===== Header Section ===== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--secondary-bg);
      border-bottom: 2px solid var(--accent-color);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
    }

    .back-link {
      text-decoration: none;
      color: var(--accent-color);
      font-size: 14px;
      padding: 10px 20px;
      border: 1px solid var(--accent-color);
      border-radius: 5px;
      text-shadow: var(--accent-shadow);
      transition: var(--transition);
      background: transparent;
    }

    .back-link:hover {
      background: var(--accent-color);
      color: var(--primary-bg);
      box-shadow: var(--glow-intense);
      transform: scale(1.05);
    }

    .page-title {
      text-align: center;
      font-size: clamp(24px, 4vw, 32px);
      color: var(--accent-color);
      text-shadow: var(--glow-intense);
      animation: titlePulse 4s ease-in-out infinite;
      flex: 1;
    }

    @keyframes titlePulse {
      0%, 100% { 
        text-shadow: 0 0 25px var(--accent-color);
        transform: scale(1);
      }
      50% { 
        text-shadow: 0 0 40px var(--accent-color), 0 0 60px var(--accent-color);
        transform: scale(1.02);
      }
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--secondary-text);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-color);
      animation: statusPulse 2s ease-in-out infinite;
    }

    .status-dot.disconnected {
      background: var(--error-color);
      animation: none;
    }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 5px var(--accent-color); }
      50% { opacity: 0.6; box-shadow: 0 0 15px var(--accent-color); }
    }

    /* ===== Control Panel ===== */
    .control-panel {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: var(--tertiary-bg);
      border-bottom: 1px solid var(--border-color);
      gap: 20px;
      flex-wrap: wrap;
    }

    .search-section {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 300px;
    }

    .search-input {
      flex: 1;
      max-width: 400px;
      padding: 10px 15px;
      background: var(--secondary-bg);
      color: var(--primary-text);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      font-family: var(--font-mono);
      font-size: 14px;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
    }

    .filter-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .log-level-filter {
      display: flex;
      gap: 5px;
      background: var(--secondary-bg);
      border-radius: 5px;
      padding: 5px;
      border: 1px solid var(--border-color);
    }

    .level-btn {
      padding: 5px 10px;
      background: transparent;
      color: var(--secondary-text);
      border: none;
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
    }

    .level-btn.active,
    .level-btn:hover {
      background: var(--accent-color);
      color: var(--primary-bg);
    }

    .control-btn {
      padding: 8px 15px;
      background: var(--secondary-bg);
      color: var(--accent-color);
      border: 1px solid var(--accent-color);
      border-radius: 5px;
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
      transition: var(--transition);
    }

    .control-btn:hover {
      background: var(--accent-color);
      color: var(--primary-bg);
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.4);
    }

    /* ===== Log Statistics ===== */
    .log-stats {
      display: flex;
      gap: 20px;
      font-size: 12px;
      color: var(--secondary-text);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stat-count {
      color: var(--accent-color);
      font-weight: bold;
    }

    /* ===== Main Logs Container ===== */
    .logs-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin: 0 20px 20px 20px;
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .logs-header {
      padding: 10px 15px;
      background: var(--tertiary-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--secondary-text);
    }

    .logs-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.5em;
      background: var(--primary-bg);
    }

    /* ===== Custom Scrollbar ===== */
    .logs-container::-webkit-scrollbar {
      width: 10px;
    }

    .logs-container::-webkit-scrollbar-track {
      background: var(--secondary-bg);
    }

    .logs-container::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 5px;
    }

    .logs-container::-webkit-scrollbar-thumb:hover {
      background: #44ff22;
    }

    /* ===== Log Entry Styles ===== */
    .log-entry {
      display: block;
      padding: 4px 0;
      border-left: 3px solid transparent;
      padding-left: 10px;
      margin-bottom: 2px;
      transition: var(--transition);
      border-radius: 0 3px 3px 0;
    }

    .log-entry:hover {
      background: rgba(57, 255, 20, 0.05);
      border-left-color: var(--accent-color);
    }

    .log-entry.hidden {
      display: none;
    }

    .log-entry.highlight {
      background: rgba(57, 255, 20, 0.1);
      border-left-color: var(--accent-color);
      animation: highlight 1s ease-out;
    }

    @keyframes highlight {
      0% { background: rgba(57, 255, 20, 0.3); }
      100% { background: rgba(57, 255, 20, 0.1); }
    }

    /* Log level styling */
    .log-entry[data-level="error"] {
      color: var(--error-color);
      border-left-color: var(--error-color);
    }

    .log-entry[data-level="warning"] {
      color: var(--warning-color);
      border-left-color: var(--warning-color);
    }

    .log-entry[data-level="info"] {
      color: var(--info-color);
      border-left-color: var(--info-color);
    }

    .log-entry[data-level="success"] {
      color: var(--success-color);
      border-left-color: var(--success-color);
    }

    .log-entry[data-level="debug"] {
      color: var(--secondary-text);
      opacity: 0.8;
    }

    .log-timestamp {
      color: var(--secondary-text);
      font-size: 11px;
      margin-right: 8px;
    }

    .log-tool {
      color: var(--accent-color);
      font-weight: bold;
      margin-right: 8px;
    }

    .log-message {
      color: var(--primary-text);
    }

    /* ===== Empty State ===== */
    .empty-logs {
      text-align: center;
      color: var(--secondary-text);
      font-style: italic;
      padding: 40px;
    }

    /* ===== Loading Animation ===== */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: var(--secondary-text);
    }

    .loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid var(--secondary-text);
      border-top: 2px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== Responsive Design ===== */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .control-panel {
        flex-direction: column;
        gap: 15px;
      }

      .search-section {
        min-width: auto;
        width: 100%;
      }

      .filter-controls {
        justify-content: center;
      }

      .logs-wrapper {
        margin: 0 10px 10px 10px;
      }

      .page-title {
        font-size: 24px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 15px;
      }

      .control-panel {
        padding: 10px 15px;
      }

      .logs-wrapper {
        margin: 0 5px 5px 5px;
      }

      .log-entry {
        font-size: 12px;
      }

      .log-level-filter {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <header class="header">
    <a href="/" class="back-link">← Back to Home</a>
    <h1 class="page-title">SECURITY LOGS</h1>
    <div class="connection-status">
      <div class="status-dot" id="connectionDot"></div>
      <span id="connectionText">Connected</span>
    </div>
  </header>

  <!-- Control Panel -->
  <div class="control-panel">
    <div class="search-section">
      <label for="search-input">🔍</label>
      <input type="text" id="search-input" class="search-input" placeholder="Search logs..." />
    </div>
    
    <div class="filter-controls">
      <div class="log-level-filter">
        <button class="level-btn active" data-level="all">ALL</button>
        <button class="level-btn" data-level="error">ERROR</button>
        <button class="level-btn" data-level="warning">WARN</button>
        <button class="level-btn" data-level="info">INFO</button>
        <button class="level-btn" data-level="debug">DEBUG</button>
      </div>
      
      <button class="control-btn" id="clearLogs">Clear</button>
      <button class="control-btn" id="exportLogs">Export</button>
      <button class="control-btn" id="pauseBtn">Pause</button>
    </div>
  </div>

  <!-- Log Statistics -->
  <div class="control-panel">
    <div class="log-stats">
      <div class="stat-item">
        <span>Total:</span>
        <span class="stat-count" id="totalCount">0</span>
      </div>
      <div class="stat-item">
        <span>Errors:</span>
        <span class="stat-count" id="errorCount">0</span>
      </div>
      <div class="stat-item">
        <span>Warnings:</span>
        <span class="stat-count" id="warningCount">0</span>
      </div>
      <div class="stat-item">
        <span>Filtered:</span>
        <span class="stat-count" id="filteredCount">0</span>
      </div>
    </div>
  </div>

  <!-- Main Logs Container -->
  <div class="logs-wrapper">
    <div class="logs-header">
      <span>Live Security Logs</span>
      <span id="lastUpdate">Last updated: Never</span>
    </div>
    <div class="logs-container" id="logsContainer">
      <div id="logs">
        <div class="loading">Loading logs...</div>
      </div>
    </div>
  </div>

  <!-- Socket.IO client for live log streaming -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    class LogsManager {
      constructor() {
        this.logsDiv = document.getElementById("logs");
        this.searchInput = document.getElementById("search-input");
        this.isPaused = false;
        this.logEntries = [];
        this.currentFilter = 'all';
        this.socket = null;
        this.stats = {
          total: 0,
          error: 0,
          warning: 0,
          info: 0,
          debug: 0
        };
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadHistoricalLogs();
        this.connectWebSocket();
        this.updateConnectionStatus(false);
      }

      setupEventListeners() {
        // Search functionality
        this.searchInput.addEventListener("input", () => this.filterLogs());

        // Level filter buttons
        document.querySelectorAll('.level-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            this.currentFilter = e.target.dataset.level;
            this.filterLogs();
          });
        });

        // Control buttons
        document.getElementById('clearLogs').addEventListener('click', () => this.clearLogs());
        document.getElementById('exportLogs').addEventListener('click', () => this.exportLogs());
        document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());

        // Auto-scroll management
        const container = this.logsDiv.parentElement;
        container.addEventListener('scroll', () => {
          const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 10;
          this.autoScroll = isAtBottom;
        });
      }

      async loadHistoricalLogs() {
        try {
          const response = await fetch("/fetch_logs");
          const data = await response.json();
          
          this.logsDiv.innerHTML = ''; // Clear loading message
          
          if (data.status === "error") {
            this.showError(`Error loading logs: ${data.message}`);
            return;
          }

          data.lines.forEach(line => this.processLogLine(line));
          this.scrollToBottom();
          this.updateLastUpdate();
          
        } catch (err) {
          this.showError(`Could not fetch logs: ${err.message}`);
        }
      }

      connectWebSocket() {
        try {
          this.socket = io();
          
          this.socket.on('connect', () => {
            this.updateConnectionStatus(true);
          });

          this.socket.on('disconnect', () => {
            this.updateConnectionStatus(false);
          });

          this.socket.on("log", (msg) => {
            if (!this.isPaused) {
              const combined = `[${msg.tool}] ${msg.line}`;
              this.processLogLine(combined);
            }
          });

        } catch (err) {
          console.error('WebSocket connection failed:', err);
          this.updateConnectionStatus(false);
        }
      }

      processLogLine(text) {
        const logEntry = this.createLogEntry(text);
        this.logEntries.push(logEntry);
        this.logsDiv.appendChild(logEntry.element);
        
        // Update statistics
        this.updateStats(logEntry.level);
        
        // Auto-scroll if needed
        if (this.autoScroll !== false) {
          this.scrollToBottom();
        }
        
        // Highlight new entries
        setTimeout(() => {
          logEntry.element.classList.add('highlight');
          setTimeout(() => logEntry.element.classList.remove('highlight'), 1000);
        }, 50);
        
        this.updateLastUpdate();
        this.filterLogs();
      }

      createLogEntry(text) {
        const entry = document.createElement("div");
        entry.className = "log-entry";
        
        // Parse log level and tool
        const level = this.detectLogLevel(text);
        const timestamp = new Date().toLocaleTimeString();
        
        entry.dataset.level = level;
        entry.dataset.originalText = text.toLowerCase();
        
        // Parse tool name
        const toolMatch = text.match(/^\[([^\]]+)\]/);
        const tool = toolMatch ? toolMatch[1] : 'SYSTEM';
        const message = toolMatch ? text.substring(toolMatch[0].length).trim() : text;
        
        entry.innerHTML = `
          <span class="log-timestamp">${timestamp}</span>
          <span class="log-tool">[${tool}]</span>
          <span class="log-message">${this.escapeHtml(message)}</span>
        `;
        
        return {
          element: entry,
          level: level,
          text: text,
          timestamp: timestamp,
          tool: tool,
          message: message
        };
      }

      detectLogLevel(text) {
        const lowerText = text.toLowerCase();
        if (lowerText.includes('error') || lowerText.includes('failed') || lowerText.includes('exception')) {
          return 'error';
        } else if (lowerText.includes('warning') || lowerText.includes('warn')) {
          return 'warning';
        } else if (lowerText.includes('info') || lowerText.includes('started') || lowerText.includes('completed')) {
          return 'info';
        } else if (lowerText.includes('debug') || lowerText.includes('trace')) {
          return 'debug';
        } else if (lowerText.includes('success') || lowerText.includes('ok') || lowerText.includes('passed')) {
          return 'success';
        }
        return 'info';
      }

      filterLogs() {
        const query = this.searchInput.value.trim().toLowerCase();
        let visibleCount = 0;
        
        this.logEntries.forEach(logEntry => {
          const element = logEntry.element;
          const matchesSearch = query.length === 0 || logEntry.text.toLowerCase().includes(query);
          const matchesLevel = this.currentFilter === 'all' || logEntry.level === this.currentFilter;
          
          if (matchesSearch && matchesLevel) {
            element.classList.remove("hidden");
            visibleCount++;
          } else {
            element.classList.add("hidden");
          }
        });
        
        document.getElementById('filteredCount').textContent = visibleCount;
      }

      updateStats(level) {
        this.stats.total++;
        if (this.stats[level] !== undefined) {
          this.stats[level]++;
        }
        
        document.getElementById('totalCount').textContent = this.stats.total;
        document.getElementById('errorCount').textContent = this.stats.error;
        document.getElementById('warningCount').textContent = this.stats.warning;
      }

      clearLogs() {
        if (confirm('Are you sure you want to clear all logs?')) {
          this.logsDiv.innerHTML = '';
          this.logEntries = [];
          this.stats = { total: 0, error: 0, warning: 0, info: 0, debug: 0 };
          this.updateStats();
          document.getElementById('filteredCount').textContent = '0';
        }
      }

      exportLogs() {
        const logText = this.logEntries
          .filter(entry => !entry.element.classList.contains('hidden'))
          .map(entry => `${entry.timestamp} ${entry.text}`)
          .join('\n');
        
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `octapus-logs-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      togglePause() {
        this.isPaused = !this.isPaused;
        const btn = document.getElementById('pauseBtn');
        btn.textContent = this.isPaused ? 'Resume' : 'Pause';
        btn.style.background = this.isPaused ? 'var(--warning-color)' : 'var(--secondary-bg)';
      }

      updateConnectionStatus(connected) {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        
        if (connected) {
          dot.classList.remove('disconnected');
          text.textContent = 'Connected';
        } else {
          dot.classList.add('disconnected');
          text.textContent = 'Disconnected';
        }
      }

      updateLastUpdate() {
        document.getElementById('lastUpdate').textContent = 
          `Last updated: ${new Date().toLocaleTimeString()}`;
      }

      scrollToBottom() {
        const container = this.logsDiv.parentElement;
        container.scrollTop = container.scrollHeight;
      }

      showError(message) {
        this.logsDiv.innerHTML = `
          <div class="log-entry" data-level="error">
            <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
            <span class="log-tool">[SYSTEM]</span>
            <span class="log-message">${this.escapeHtml(message)}</span>
          </div>
        `;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Initialize the logs manager when DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      new LogsManager();
    });
  </script>
</body>
</html>
